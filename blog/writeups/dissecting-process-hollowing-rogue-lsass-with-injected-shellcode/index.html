<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dissecting Shellcode Execution in Memory | Tracepoint</title>
<link rel="stylesheet" href="/Tracepoint/css/styles.css?v=3">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Additional styles for this specific page */
.container {
  max-width: 980px;
  margin: 20px auto 60px;
  padding: 0 16px;
}
.content {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 28px;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
}
h2, h3, h4 {
  text-align: center;
  margin-top: 60px;
  margin-bottom: 20px;
  position: relative;
}
h2::after, h3::after, h4::after {
  content: "";
  display: block;
  width: 60px;
  height: 2px;
  background: var(--accent-purple);
  margin: 10px auto 0;
}
h2 { font-size: 1.8em; }
h3 { font-size: 1.4em; }
h4 { font-size: 1.2em; }
p {
  line-height: 1.65;
  margin: 12px 0;
}
ul, ol {
  margin-left: 20px;
  line-height: 1.65;
}
a {
  color: var(--accent-purple);
  text-decoration: none;
  border-bottom: 1px dotted var(--accent-purple);
}
a:hover {
  color: #000;
  border-bottom-color: #000;
}

.callout {
  border: 1px dashed var(--accent-purple-border);
  background: var(--accent-purple-light);
  padding: 14px;
  border-radius: 8px;
  margin: 18px 0;
}
code.inline-code {
  background: rgba(138, 43, 226, 0.1);
  color: #e0e0e0;
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid rgba(138, 43, 226, 0.3);
  font-family: "Courier New", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: 0.9em;
  font-weight: 500;
}

.callout code.inline-code {
  background: none;
  color: var(--text-secondary);
  border: none;
  padding: 0;
}
.figure {
  margin: 18px 0;
  text-align: center;
}
.figure img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.15);
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  cursor: zoom-in;
}
.figure figcaption {
  color: #222;
  font-size: 13px;
  margin-top: 6px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
}
th, td {
  border: 1px solid #e2e2f0;
  padding: 8px 10px;
  vertical-align: top;
}
th {
  background: #f6f5fe;
  text-align: left;
}
.meta-top {
  color: #2a2a2a;
  font-size: 14px;
  margin-bottom: 8px;
}
.badge {
  display: inline-block;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 999px;
  color: #fff;
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  margin-left: 6px;
}
.back {
  margin-bottom: 14px;
}
.back a {
  color: #fff;
  border-bottom: 1px dotted #fff;
  text-decoration: none;
}
.table-container { overflow-x: auto; }
.lightbox {
  position: fixed; inset: 0;
  background: rgba(15,15,23,.95);
  display: grid; place-items: center;
  opacity: 0; visibility: hidden;
  transition: .2s ease;
  z-index: 9999;
}
.lightbox.show { opacity: 1; visibility: visible; }
.lightbox img {
  max-width: 92vw; max-height: 90vh;
  object-fit: contain; border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,.6);
  background: #000;
}
.lightbox .caption {
  color: #fff; margin-top: 10px; text-align: center; max-width: 92vw;
  font-size: 14px; opacity: .9;
}
.lightbox .btn {
  position: absolute; top: 50%; transform: translateY(-50%);
  background: rgba(0,0,0,.5); color: #fff; border: 1px solid var(--accent-purple-border);
  width: 42px; height: 42px; border-radius: 999px; font-size: 22px;
  display: grid; place-items: center; cursor: pointer; user-select: none;
}
.lightbox .btn:hover { background: rgba(0,0,0,.75); }
.lightbox .prev { left: 16px; }
.lightbox .next { right: 16px; }
.lightbox .close {
  top: 16px; right: 16px; transform: none; width: 38px; height: 38px; font-size: 20px;
}
</style>
</head>
<body>
<header>
<h1>Tracepoint</h1>
<nav>
<a href="../../../">Home</a>
<a href="../../../about/">About</a>
<a href="../../">Blog</a>
<a href="../../../projects/">Projects</a>
<a href="../../../certifications/">Certifications</a>
<a href="../../../contact/">Contact</a>
</nav>
</header>

<!-- Theme Toggle -->
<button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">🌙</button>
<div class="container">
<div class="back"><a href="../../">&larr; Back to Writeups</a></div>
<div class="content">
<div class="meta-top">
<strong>Dissecting Shellcode Execution in Memory</strong>
<span class="badge">DFIR</span>
<span class="badge">Memory Forensics</span>
</div>
<h5>In this writeup, I walk through the forensic investigation of an infected memory image, identifying the malicious process, reconstructing its execution chain, and documenting the artifacts it left behind</h5>
<hr>
<h3><strong>Introduction</strong></h3>
<p>The memory image analyzed in this writeup was provided as part of the 13Cubed "Investigating Windows Memory" course and can also be found in <a href="https://www.youtube.com/watch?v=x5mGPAG41I4">this</a> Youtube video. The intent of this memory image is to display how "Process Hollowing" can be analyzed\determined using Volatility 3.</p>
<p><strong>Goal:</strong></p>
<p>The goal of the investigation is to determine whether or not Process hollowing was really in place, what were the affects on the host, how was it executed and what evidence did it leave in memory that we can investigate.</p>
<hr>
<h3><strong>Methodology</strong></h3>
<p><strong>Tools</strong>:</p>
<p>The investigation mostly leverages <code class="inline-code">volatility3</code> to analyze and dissect the memory image.</p>
<p>Other tools used during the investigation are  <code class="inline-code">MemProcFS + YARA</code>, for further enrichment where volatility fails, multiple <code class="inline-code">Eric Zimermman tools</code> for easier artifact analysis, <code class="inline-code">PEstudio</code> for high-level binary analysis.</p>
<hr>
<h3><strong>Investigation</strong></h3>
<p><strong>Basic system information</strong>:</p>
<pre class="command-line"><code>windows.info</code></pre>
<p>This plugin basic metadata information such as: </p>
<p><code class="inline-code">SystemTime</code> - the time at which the image was taken</p>
<p><code class="inline-code">MajorOperatingSystemVersion</code> - Windows Version</p>
<p><code class="inline-code">Major/Minor</code> - Release version.</p>
<figure class="figure">
<img src="./assets/windows.info.png" alt="windows.info">
<figcaption>windows.info</figcaption>
</figure>
<p>The plugin suggests that the Windows version is Windows 10 but the <code class="inline-code">Major/Minor</code>, which are "15.26100", seem to mismatch. So we will query the registry to determine the version more accurately:</p>
<pre class="command-line"><code>windows.registry.printkey --key "Microsoft\Windows NT\CurrentVersion" | grep -E "ProductName|ReleaseId|CurrentBuild|CurrentBuildNumber|CompositionEditionID|DisplayVersion"</code></pre>
<figure class="figure">
<img src="./assets/Query windows version registry.png" alt="Query windows version registry">
<figcaption>Query windows version registry</figcaption>
</figure>
<p>We an conclude this is Windows 11 because of the <strong>build number</strong>:</p>
<ul>
<li><code class="inline-code">CurrentBuild = 26100</code> and <code class="inline-code">DisplayVersion = 24H2</code> → these belong to <strong>Windows 11 24H2</strong>.</li>
<li>Windows 10 never went beyond build <strong>19045 (22H2)</strong>.</li>
<li><code class="inline-code">ProductName</code> can still say "Windows 10 Pro" due to upgrade leftovers, so it’s not reliable.</li>
</ul>
<p><strong>Rule of thumb</strong>: Any build <strong>≥ 22000</strong> is Windows 11, regardless of what <code class="inline-code">ProductName</code> says.</p>
<pre><code class="sourceCode">windows.sessions</code></pre>
<p>This plugin helps us determine the Hostname and Username:</p>
<figure class="figure">
<img src="./assets/windows.sessions.png" alt="windows.sessions">
<figcaption>windows.sessions</figcaption>
</figure>
<p>Hostname: <code class="inline-code">DESKTOP-MAHIJHF</code></p>
<p>Username: <code class="inline-code">User</code></p>
<p>Due to some corruptions in the memory - I was not able to get the local IP address at this stage.</p>
<h3>System Information</h3>
<div class="callout"><ul>
<li><strong>OS Version</strong>: <code class="inline-code">Windows 11</code></li>
<li><strong>System Time (at capture)</strong>: <code class="inline-code">2025-01-27 02:31:50 (UTC)</code></li>
<li><strong>Hostname</strong>: <code class="inline-code">DESKTOP-MAHIJHF</code></li>
<li><strong>Username</strong>: <code class="inline-code">User</code></li>
</ul></div>
<p><strong>Process enumeration</strong></p>
<p>Starting off with simple process enumeration:</p>
<pre><code class="sourceCode">windows.pslist</code></pre>
<p><code class="inline-code">windows.pslist</code> in Volatility walks the <strong>ActiveProcessLinks</strong> doubly-linked list in the EPROCESS structure.</p>
<div class="callout"><ul>
<li>Every process has an <code class="inline-code">ActiveProcessLinks</code> entry that points <strong>forward and backward</strong> to its neighbors.</li>
<li>Together they form a <strong>circular doubly-linked list</strong> anchored at <code class="inline-code">PsActiveProcessHead</code>.</li>
<li>By traversing this list, <code class="inline-code">pslist</code> shows all "linked" processes that the OS knows about.</li>
</ul></div>
<p><strong>Note:</strong> Hidden processes (e.g. DKOM) won't be seen by <code class="inline-code">windows.pslist</code>.</p>
<p>To efficiently analyze and triage the output of <code class="inline-code">windows.pslist</code> we can rely on the "<a href="https://medium.com/@leo.valentic9/windows-process-genealogy-understanding-and-analyzing-key-system-processes-in-digital-forensics-a88cd5b9698f">Windows Process Genealogy</a>" - that way we can more easily tell which processes are most likely benign and which stand out. </p>
<p>Starting off with<code class="inline-code">svchost.exe</code>, which is one of the most prevalent process on any given Windows system.</p>
<p>As such, quickly identifying whether it's instances are benign or potentially malicious will help us cut down on the result we need to analyze.</p>
<p><code class="inline-code">svchost.exe</code> should always be the child process of <code class="inline-code">services.exe</code> on modern Windows systems.</p>
<pre class="command-line"><code>windows.pslist | grep -i svchost</code></pre>
<p>As we can see, all of the <code class="inline-code">svchost.exe</code> instances share the same <code class="inline-code">PPID - 772</code>:</p>
<figure class="figure">
<img src="./assets/svchost emum.png" alt="svchost emum">
<figcaption>svchost emum</figcaption>
</figure>
<p>Enumerating <code class="inline-code">PID 772</code>: </p>
<pre><code class="sourceCode">windows.pslist | grep 772 | grep -i services</code></pre>
<p>As expected <code class="inline-code">PID 772</code> algins with <code class="inline-code">services.exe</code></p>
<figure class="figure">
<img src="./assets/services pid enum.png" alt="services pid enum">
<figcaption>services pid enum</figcaption>
</figure>
<p>With the <code class="inline-code">svchost.exe</code> instances deemed benign, attention shifts to other processes. <code class="inline-code">windows.pslist</code> shows <strong>two <code class="inline-code">lsass.exe</code> processes</strong>, a clear red flag since only one should exist, and it must always be a child of <code class="inline-code">wininit.exe</code>.</p>
<pre><code class="sourceCode">windows.pslist | grep -i lsass.exe</code></pre>
<figure class="figure">
<img src="./assets/lsass.exe enum.png" alt="lsass.exe enum">
<figcaption>lsass.exe enum</figcaption>
</figure>
<p>The suspicious process is likely <code class="inline-code">PID 12028</code>. Since <code class="inline-code">wininit.exe</code> starts early in the boot process-and <code class="inline-code">lsass.exe</code> should follow right after-seeing an <code class="inline-code">lsass.exe</code> with a high PID like <code class="inline-code">12028</code> and a parent of <code class="inline-code">11872</code> strongly suggests it’s malicious.</p>
<p>But we can also easily verify this:</p>
<pre><code class="sourceCode">windows.pslist | grep 628</code></pre>
<figure class="figure">
<img src="./assets/PID 628.png" alt="PID 628">
<figcaption>PID 628</figcaption>
</figure>
<p><code class="inline-code">PID 628</code> is <code class="inline-code">wininit.exe</code>, spawning <code class="inline-code">lsass.exe (792)</code> and <code class="inline-code">services.exe</code>.</p>
<p>Using <code class="inline-code">windows.pstree</code> (exported to a .txt for readability) </p>
<figure class="figure">
<img src="./assets/pstree output.png" alt="pstree output">
<figcaption>pstree output</figcaption>
</figure>
<p>the rogue <code class="inline-code">lsass.exe (PID 12028)</code> is shown spawning <code class="inline-code">cmd.exe (PID 12088)</code>, which in turn launches <code class="inline-code">systeminfo.exe (PID 5240)</code> and <code class="inline-code">conhost.exe (PID 12100)</code>. <strong>Legitimate LSASS never spawns child processes</strong>, so this parent-child chain confirms the second <code class="inline-code">lsass.exe</code> is tampered/malicious.</p>
<p>Deeper process enumeration:</p>
<pre><code class="sourceCode">windows.psscan</code></pre>
<p><code class="inline-code">pslist</code> relies on the active process linked list, so it only shows processes still linked into the OS.  </p>
<p><code class="inline-code">psscan</code> scans memory for EPROCESS structures directly, allowing it to catch hidden or terminated processes that no longer appear in the list.</p>
<p>I couldn’t find any process matching the <code class="inline-code">PPID</code> 11872 for the suspicious <code class="inline-code">lsass.exe</code> using <code class="inline-code">pslist</code>. Although <code class="inline-code">psscan</code> often uncovers additional evidence, it produced no useful results in this case.</p>
<pre><code class="sourceCode">windows.netscan
windows.netstat</code></pre>
<p>Both of these plugins provide network data, local and remote IPs, ports and associated process but for this memory image the data seems to be unavailable, we do get the local IP address but the remote IP addresses are blank:</p>
<figure class="figure">
<img src="./assets/network details.png" alt="network details">
<figcaption>network details</figcaption>
</figure>
<h3>Findings</h3>
<div class="callout"><ul>
<li><strong>Suspicious Processes</strong></li>
<li><code class="inline-code">12028 - lsass.exe</code></li>
<li><code class="inline-code">12088 - cmd.exe</code></li>
<li><code class="inline-code">5240 - systeminfo.exe</code></li>
<li><code class="inline-code">12100 - conhost.exe</code></li>
<li><strong>Host IP Address</strong></li>
<li><code class="inline-code">192.168.0.165</code></li>
</ul></div>
<hr>
<h3><strong>Investigation - Finding malware in memory</strong></h3>
<p>Now that suspicious activity and related processes have been identified, the next step is to dig deeper. Given the evidence, the primary focus will be on the anomalous <code class="inline-code">lsass.exe</code>, which is likely at the core of this compromise.</p>
<p><strong>Investigating handles - <code class="inline-code">lsass.exe</code>:</strong></p>
<p><code class="inline-code">windows.handles</code> lists the handles each process has open (files, registry keys, mutexes, events, named pipes, etc.), Which gives us evidence that reveal what a process is interacting with.</p>
<pre><code class="sourceCode">windows.handles --pid 12028</code></pre>
<figure class="figure">
<img src="./assets/lsass.exe handles.png" alt="lsass.exe handles">
<figcaption>lsass.exe handles</figcaption>
</figure>
<ul>
<li><strong>Process handle</strong> → <code class="inline-code">cmd.exe</code> (PID 12088) with <code class="inline-code">GrantedAccess = 0x1fffff</code> (<code class="inline-code">PROCESS_ALL_ACCESS</code>) indicates full control, consistent with process injection or manipulation <a href="https://www.mdpi.com/2076-3417/12/15/7746">1, </a><a href="https://www.scriptchildie.com/evasion/edr-bypass/2.-userland-hooks/4.-direct-and-indirect-syscalls-shellcode-runner">2, </a><a href="https://web.archive.org/web/20250218035455/https://rastamouse.me/dumping-lsass-with-duplicated-handles/">3</a>.</li>
<li><strong>Thread handle</strong> → <code class="inline-code">cmd.exe</code> TID 12092 with the same access rights suggests remote-thread style execution control .</li>
<li><strong>File handle</strong> → <code class="inline-code">\Users\User\Downloads</code> is unusual for <code class="inline-code">lsass.exe</code>, pointing to possible user-space file enumeration\interaction.</li>
<li><strong>Network handle</strong> → <code class="inline-code">\Device\Afd\Endpoint</code> inside <code class="inline-code">lsass.exe</code> is suspicious here; while LSASS can legitimately use such sockets, in this context it suggests potential malicious network activity (C2, exfiltration, lateral movement). IP/port details couldn’t be confirmed since <code class="inline-code">netscan</code> produced no output.</li>
</ul>
<p><strong>Investigating handles - <code class="inline-code">cmd.exe</code>:</strong></p>
<pre><code class="sourceCode">windows.handles --pid 12088</code></pre>
<figure class="figure">
<img src="./assets/cmd.exe handles.png" alt="cmd.exe handles">
<figcaption>cmd.exe handles</figcaption>
</figure>
<ul>
<li><strong><code class="inline-code">\Users\User\Downloads</code></strong> - This shows <code class="inline-code">cmd.exe</code> enumerating or interacting with the Downloads folder. While not malicious by itself, in the context of being spawned by a rogue <code class="inline-code">lsass.exe</code>, it suggests the attacker may have been browsing user files or interacting with the directory in some way.</li>
<li><strong><code class="inline-code">\Device\Afd\Endpoint</code></strong> - <code class="inline-code">cmd.exe</code> normally doesn’t handle raw sockets or network endpoints. Seeing an AFD handle here strongly suggests that commands were executed through this shell which initiated or supported network activity (e.g., C2 communication, data transfer, or lateral movement).</li>
</ul>
<p>On its own, <code class="inline-code">cmd.exe</code> may not appear overtly suspicious, but the presence of handles to the <strong>Downloads folder</strong> and <strong>AFD Endpoint</strong>, combined with its parent-child relationship to the rogue <code class="inline-code">lsass.exe</code>, indicates it was actively leveraged for attacker operations.</p>
<p><strong>Detecting Memory Injection with <code class="inline-code">ldrmodules</code>, <code class="inline-code">malfind</code> and <code class="inline-code">ProcSentinel</code>:</strong></p>
<p><code class="inline-code">windows.ldrmodules</code> inspects the PEB’s DLL lists (InLoadOrder, InInitOrder, InMemOrder) to spot inconsistencies that indicate hidden/injected modules. It also shows each module’s <strong>Mapped Path</strong>: legit DLLs should map from <strong>System32/SysWOW64 (along with a few others)</strong>. <strong>Unusual paths</strong> (e.g., Downloads, Temp) <strong>or a blank path</strong> (often memory-only/manual-mapped or deleted-on-disk) are strong injection/tampering indicators.</p>
<p><code class="inline-code">lsass.exe - PID 12028</code></p>
<pre><code class="sourceCode">windows.ldrmodules --pid 12028</code></pre>
<figure class="figure">
<img src="./assets/lsass.exe ldrmodules enum.png" alt="lsass.exe ldrmodules enum">
<figcaption>lsass.exe ldrmodules enum</figcaption>
</figure>
<p>In <code class="inline-code">lsass.exe</code>, the module at <code class="inline-code">0x140000000</code> is absent from all PEB lists and has no mapped path, strongly indicating memory-resident injected code (manual mapping/reflective injection).</p>
<p>I will quickly mention that cmd.exe does not show anything of note.</p>
<p>The <strong><code class="inline-code">malfind</code></strong> plugin identifies <strong>injected code or DLLs</strong> in user-mode memory by analyzing VAD structures and memory protections. It highlights regions that are <strong>private and executable</strong>-especially when marked <strong>RWX</strong>-since they lack file mappings and remain hidden from standard inspection tools.</p>
<p><code class="inline-code">lsass.exe - PID 12028</code></p>
<pre class="cyber"><code class="sourceCode">windows.malfind --pid 12028</code></pre>
<figure class="figure">
<img src="./assets/lsass.exe malfind.png" alt="lsass.exe malfind">
<figcaption>lsass.exe malfind</figcaption>
</figure>
<p>In <code class="inline-code">lsass.exe</code>, <code class="inline-code">malfind</code> reveals an RWX memory region (<code class="inline-code">0x140000000-0x140004fff</code>) containing an <code class="inline-code">MZ</code> header with no backing file, confirming a reflectively injected PE. The region is marked <code class="inline-code">PAGE_EXECUTE_READWRITE</code>, a highly suspicious protection flag since legitimate modules are rarely loaded with both write and execute permissions - a strong indicator of malicious code injection.</p>
<p><strong><code class="inline-code">windows.procsentinel</code></strong> is a fairly new plugin that scans processes for anomalies such as hollowing, injected code, suspicious RWX regions, or duplicate singleton processes (like multiple <code class="inline-code">lsass.exe</code>). It also dumps suspicious memory regions for deeper analysis.</p>
<pre><code class="sourceCode">windows.procsentinel</code></pre>
<figure class="figure">
<img src="./assets/procsentinel.png" alt="procsentinel">
<figcaption>procsentinel</figcaption>
</figure>
<p><code class="inline-code">windows.procsentinel</code> flags both a duplicate <code class="inline-code">lsass.exe</code> (singleton anomaly) and an RWX memory region with an MZ header, aligning with ATT&amp;CK T1036 (Masquerading) and T1055 (Process Injection), confirming malicious tampering.</p>
<p>Before wrapping up this section, we know that both <code class="inline-code">lsass.exe</code> and <code class="inline-code">cmd.exe</code> interacted with the <code class="inline-code">Downloads</code> directory - making it a natural pivot point. We can use <code class="inline-code">windows.filescan</code> to quickly check for suspicious files:</p>
<pre><code class="sourceCode">windows.filescan | grep \Downloads</code></pre>
<figure class="figure">
<img src="./assets/filescan downloads.png" alt="filescan downloads">
<figcaption>filescan downloads</figcaption>
</figure>
<p>The results reveal a file named <strong><code class="inline-code">invoice.pdf.exe</code></strong> in the <code class="inline-code">Downloads</code> folder - a classic <strong>masquerading technique</strong> where a malicious executable disguises itself as a benign document.</p>
<h3>Findings</h3>
<div class="callout"><ul>
<li><strong>Rogue <code class="inline-code">lsass.exe</code> (PID 12028)</strong> - duplicate singleton with a reflectively injected PE (<code class="inline-code">RWX</code> region, MZ header, no mapped path).</li>
<li><strong><code class="inline-code">cmd.exe</code> (PID 12088)</strong> - spawned as a child of the rogue LSASS, interacting with the <code class="inline-code">Downloads</code> directory.</li>
<li><strong>Suspicious file <code class="inline-code">invoice.pdf.exe</code></strong> - discovered in <code class="inline-code">Downloads</code>, posing as a document to evade detection.</li>
</ul></div>
<h3>Mapped TTPs (MITRE ATT&amp;CK)</h3>

<div class="callout">
  <ul>
    <li><strong>Process Injection (T1055)</strong> - reflective PE injection into <code class="inline-code">lsass.exe</code>.</li>
    <li><strong>Masquerading (T1036)</strong>
      <ul>
        <li>Rogue <code class="inline-code">lsass.exe</code> imitating a legitimate system process.</li>
        <li><code class="inline-code">invoice.pdf.exe</code> mimicking a benign PDF.</li>
      </ul>
    </li>
  </ul>
</div>

<div class="callout">
  <ul>
    <li><strong>Command and Scripting Interpreter (T1059)</strong> - attacker use of <code class="inline-code">cmd.exe</code>.</li>
  </ul>
</div>
<h3><strong>Investigation - Extracting artifacts for disk based analysis</strong></h3>
<p>Now that we have solid evidence of malicious activity, including processes and files present in the memory image we can pivot to a more traditional disk based forensics by extracting several artifacts:</p>
<ul>
<li><strong>ShimCache (AppCompatCache)</strong> - treat as <strong>evidence of presence</strong>, not reliable proof of execution. Use it mainly to show a file existed (with rare exceptions <a href="https://www.youtube.com/watch?v=DsqKIVcfA90">1</a>, <a href="https://github.com/EricZimmerman/AppCompatCacheParser/issues/6">2</a>). Even if the SYSTEM hive can’t be exported, Volatility 3’s <code class="inline-code">windows.shimcache</code> can parse it from memory. Note limitations and corroborate with Amcache/PCA/Prefetch.</li>
<li><strong>Amcache</strong> - install/execution metadata (path, hash, timestamps).</li>
<li><strong>PCA (Program Compatibility Assistant)</strong> - AppCompat traces tied to user launches.</li>
<li><strong>Prefetch</strong> - Evidence of execution for PE binaries.</li>
<li><strong>Event logs (EVTX)</strong> - Mostly Windows Defender.</li>
<li><strong>Suspect files and processes</strong> - copy <code class="inline-code">invoice.pdf.exe</code> and dump suspicious process (<code class="inline-code">lsass.exe</code>) memory/files for further analysis.</li>
</ul>
<p><strong>Shimcache:</strong></p>
<pre><code class="sourceCode">windows.shimcachemem</code></pre>
<figure class="figure">
<img src="./assets/shimcachemem.png" alt="shimcachemem">
<figcaption>shimcachemem</figcaption>
</figure>
<p>Note that the timestamps are <strong>Last Modified</strong> - they do not indicate execution time. Entries higher in the list were shimmed more recently.</p>
<p>We find a high-priority anomaly:</p>
<pre><code class="sourceCode">C:\Users\User\AppData\Local\Temp\svchost.exe </code></pre>
<p>This nonstandard path is an immediate red flag and needs investigation.</p>
<p>The remaining hits - <code class="inline-code">invoice.pdf.exe</code>, <code class="inline-code">conhost.exe</code> (spawned by <code class="inline-code">cmd.exe</code> but <code class="inline-code">cmd.exe</code> itself is absent here), <code class="inline-code">whoami.exe</code>, and <code class="inline-code">systeminfo.exe</code> - align with earlier findings and further corroborate the activity.</p>
<p><strong>Amcache:</strong></p>
<figure class="figure">
<img src="./assets/Amcachehve.png" alt="Amcachehve">
<figcaption>Amcachehve</figcaption>
</figure>
<p>I exported <strong>AmCache.hve</strong> and parsed it in <strong>RegistryExplorer</strong>. AmCache helps build an execution timeline (e.g., <code class="inline-code">LastRunTime</code>) and records file metadata, including <strong>SHA1</strong>. Critically, it shows <strong><code class="inline-code">invoice.pdf.exe</code></strong> with <strong>SHA1</strong>:  </p>
<p>"<code class="inline-code">f0780bcf35ef2324769d29778010f74ee76a32b9</code>".</p>
<p><strong>PCA:</strong></p>
<figure class="figure">
<img src="./assets/PCA evidence.png" alt="PCA evidence">
<figcaption>PCA evidence</figcaption>
</figure>
<p>Located at <code class="inline-code">C:\Windows\appcompat\pca\PcaAppLaunchDic.txt</code>, this artifact gives us another evidence that <code class="inline-code">invoice.pdf.exe</code> was indeed executed</p>
<p><strong>Prefetch:</strong></p>
<figure class="figure">
<img src="./assets/prefetch.png" alt="prefetch">
<figcaption>prefetch</figcaption>
</figure>
<p><strong>Prefetch</strong> confirms execution of <code class="inline-code">whoami.exe</code> and <code class="inline-code">ipconfig.exe</code> (<code class="inline-code">WHOAMI.EXE-9D378AFE.pf</code>, <code class="inline-code">IPCONFIG.EXE-BFEC2AD0.pf</code> - likely used for reconnaissance). As well as the other indicators we observed before. While Prefetch doesn’t record parentage, the <code class="inline-code">Date Modified</code> timestamps align with the <code class="inline-code">cmd.exe</code> spawned by the rogue <code class="inline-code">lsass.exe</code>, making it the likely launcher.</p>
<p><strong>Event logs (EVTX)</strong></p>
<p>I found little of value in most EVTX due to corruption/lack of signal, but <strong>Windows Defender (Operational)</strong> provided clear evidence:</p>
<figure class="figure">
<img src="./assets/defender exclusion.png" alt="defender exclusion">
<figcaption>defender exclusion</figcaption>
</figure>
<figure class="figure">
<img src="./assets/defender real time protection.png" alt="defender real time protection">
<figcaption>defender real time protection</figcaption>
</figure>
<ul>
<li><strong>2025-01-27 02:27:18</strong> - <code class="inline-code">Downloads</code> folder added to Defender exclusions.</li>
<li><strong>2025-01-27 02:27:51</strong> - Defender Real-Time Protection disabled.</li>
</ul>
<p>These actions significantly reduce detection on the host and likely enabled execution from <code class="inline-code">Downloads</code> without interception.  </p>
<p><strong>MITRE ATT&amp;CK</strong>: <strong>T1562.001 - Impair Defenses (Disable or Modify Tools)</strong>.</p>
<h3>Investigation - Poor man's malware analysis:</h3>
<p>This section uses basic triage tools-<strong>PEStudio</strong>, <strong>strings</strong>, and <strong>MemProcFS</strong> (for running Elastic YARA).</p>
<p>Target: <code class="inline-code">svchost.exe</code> at <code class="inline-code">C:\Users\User\AppData\Local\Temp\</code></p>
<p><strong>PEStudio - basic info</strong>  </p>
<figure class="figure">
<img src="./assets/PEStudio basic.png" alt="PEStudio basic">
<figcaption>PEStudio basic</figcaption>
</figure>
<ul>
<li><strong>SHA256:</strong> <code class="inline-code">79AEC4FDF6CC931BCEE95EA14F627AA7347DFDD861290BD40F518580CE028D86</code></li>
<li><strong>Compilation time:</strong> <code class="inline-code">Thu Jan 23 01:18:33 2025 (UTC)</code></li>
</ul>
<p><strong>PEStudio - flagged imports</strong>  </p>
<figure class="figure">
<img src="./assets/PEStudio imports.png" alt="PEStudio imports">
<figcaption>PEStudio imports</figcaption>
</figure>
<p>Seven imports consistent with a hollowing/remote-injection toolchain:</p>
<pre><code class="sourceCode">CreateProcessA
GetThreadContext
SetThreadContext
VirtualAllocEx
VirtualProtect
VirtualQuery
WriteProcessMemory</code></pre>
<p><strong>Assessment</strong>  </p>
<p>Given the confirmed memory-resident injection in LSASS and the abnormal Temp path, this import set strongly corroborates a <strong>process hollowing / remote injection</strong> utility. Imports alone show capability, but together with the RWX+MZ region and prior artifacts, confidence is high that this <code class="inline-code">svchost.exe</code> is malicious.</p>
<p><strong>Strings</strong>  </p>
<figure class="figure">
<img src="./assets/svchost.exe injecting.png" alt="svchost.exe injecting">
<figcaption>svchost.exe injecting</figcaption>
</figure>
<figure class="figure">
<img src="./assets/svchost hollowing.png" alt="svchost hollowing">
<figcaption>svchost hollowing</figcaption>
</figure>
<p>Strings and imports together narrate a textbook RunPE/process-hollowing sequence: a benign host is created with its primary thread suspended (<code class="inline-code">CreateProcess</code>), remote memory is reserved in the target (<code class="inline-code">VirtualAllocEx</code>), the payload's PE headers and sections are written in (<code class="inline-code">WriteProcessMemory</code>), the thread context is redirected to the payload entry point (<code class="inline-code">GetThreadContext</code>/<code class="inline-code">SetThreadContext</code>), and execution is handed off by resuming the thread (<code class="inline-code">ResumeThread</code>)-a flow squarely consistent with <strong>MITRE ATT&amp;CK T1055.012 (Process Hollowing)</strong>.</p>
<hr>
<p>Target: <code class="inline-code">invoice.pdf.exe</code> at <code class="inline-code">C:\Users\User\Downloads\</code></p>
<p><strong>PEStudio - basic info</strong>  </p>
<figure class="figure">
<img src="./assets/invoice pestuio basic.png" alt="invoice pestuio basic">
<figcaption>invoice pestuio basic</figcaption>
</figure>
<ul>
<li><strong>SHA256:</strong> <code class="inline-code">B37156CF3019561D48E05F8258C51297C6CD0CC220FA3B7BD82EB13D549BEB63</code></li>
</ul>
<ul>
<li><strong>Compilation time:</strong> <code class="inline-code">N/A</code></li>
</ul>
<p><strong>PEStudio - flagged imports</strong>  </p>
<figure class="figure">
<img src="./assets/invoice pestuio imports.png" alt="invoice pestuio imports">
<figcaption>invoice pestuio imports</figcaption>
</figure>
<ul>
<li>Injection/hollowing primitives - <code class="inline-code">GetThreadContext</code>, <code class="inline-code">SetThreadContext</code>, <code class="inline-code">SuspendThread</code>, <code class="inline-code">SwitchToThread</code>, <code class="inline-code">VirtualAlloc</code>, <code class="inline-code">VirtualQuery</code></li>
<li>Dropper / I-O / UX - <code class="inline-code">WriteFile</code>, <code class="inline-code">SetConsoleCtrlHandler</code>, <code class="inline-code">GetEnvironmentStringsW</code>, <code class="inline-code">GetCurrentThreadId</code></li>
<li>Anti-debug / packer hints - <code class="inline-code">AddVectoredExceptionHandler</code>, <code class="inline-code">AddVectoredContinueHandler</code></li>
<li>Telemetry evasion - <code class="inline-code">WerSetFlags</code></li>
</ul>
<p><strong>Strings</strong>  </p>
<figure class="figure">
<img src="./assets/invoice strings.png" alt="invoice strings">
<figcaption>invoice strings</figcaption>
</figure>
<ul>
<li>Go loader markers - <code class="inline-code">go1.23.5</code>, <code class="inline-code">GOOS=windows</code>, <code class="inline-code">GOARCH=amd64</code>, <code class="inline-code">CGO_ENABLED=0</code>, <code class="inline-code">go:buildid</code></li>
<li>Developer artifact - <code class="inline-code">C:/Users/Mike/Desktop/malware/invoice2.pdf.go</code></li>
<li>_Implication:_ not a real PDF; indicates a build path on a developer machine with username</li>
<li><strong>Mike</strong> (paths can be spoofed, but it’s a useful lead).</li>
<li>Process launch/env - <code class="inline-code">os.StartProcess</code>, <code class="inline-code">CreateEnvironmentBlock</code></li>
<li>Memory staging / thread control - <code class="inline-code">SuspendThread</code>, <code class="inline-code">ResumeThread</code>, <code class="inline-code">Get/SetThreadContext</code>, <code class="inline-code">VirtualAlloc</code>, <code class="inline-code">VirtualQuery</code>, <code class="inline-code">DuplicateHandle</code>, <code class="inline-code">CreateThread</code>, <code class="inline-code">LoadLibraryW/ExW</code></li>
<li>Networking - <code class="inline-code">WSASocket</code>, <code class="inline-code">WSAGetOverlappedResult</code></li>
<li>Packer / anti-debug - <code class="inline-code">AddVectoredExceptionHandler</code>, <code class="inline-code">AddVectoredContinueHandler</code>, <code class="inline-code">WerSetFlags</code></li>
</ul>
<p><strong>Assessment</strong>  </p>
<p>Imports and strings together indicate a <strong>Go-based loader</strong> designed to <strong>stage and inject code</strong> (hollowing/reflective injection). The developer path string ties the sample to a Windows build environment under the account <strong>Mike</strong>.</p>
<h4><code class="inline-code">invoice.pdf.exe</code> - <code class="inline-code">svchost.exe</code> relationship:</h4>
<p><strong>Actor (controller/launcher) - <code class="inline-code">invoice.pdf.exe</code></strong>  </p>
<p>Masquerading loader executed by the user.  </p>
<p>Orchestrates the attack by launching the next-stage tool.</p>
<p><strong>Action file/process (injector/tool) - <code class="inline-code">C:\Users\User\AppData\Local\Temp\svchost.exe</code></strong>  </p>
<p>Malicious injector that performs process hollowing/reflective injection into <code class="inline-code">lsass.exe</code> (memory-resident PE).</p>
<p><strong>Victim/target process - <code class="inline-code">lsass.exe</code></strong>  </p>
<p>Hosts the injected code and subsequently enables attacker activity (e.g., spawning <code class="inline-code">cmd.exe</code>).</p>
<p>Amcache provides <strong>execution evidence</strong> that <code class="inline-code">invoice.pdf.exe</code> ran; its strings indicate a Go-based loader. The Temp <code class="inline-code">svchost.exe</code> shows classic hollowing imports/strings, and LSASS contains an unmapped RWX region with an MZ header-consistent with reflective injection-followed by an anomalous <code class="inline-code">cmd.exe</code> child. Their absence in <code class="inline-code">pslist/psscan</code> is likely due to short-lived execution.</p>
<hr>
<p>Target: <code class="inline-code">lsass.exe PID 12028</code> </p>
<p><strong>Elastics's YARA Rules</strong></p>
<p>Elastic YARA scanning of the injected VAD in <strong>LSASS (PID 12028)</strong> at <strong>0x0000000140000000</strong> produced three hits: <strong>Windows_Trojan_Metasploit_7bc0f998</strong>, <strong>Windows_Trojan_Metasploit_c9773203</strong>, and <strong>Windows_Trojan_Metasploit_91bc5d7d</strong>. These rules match the canonical x64 API-hashing/resolver stub used by Metasploit and derivatives. The matched bytes reference <strong>ws2_32</strong> and include the inline IPv4 connect tuple <strong>02 00 0d 3d c0 a8 00 9d</strong>, which decodes to <strong>AF_INET, 192.168.0.157:3389</strong>. All hits fall within the same <strong>unmapped RWX region with an MZ header</strong> previously identified by <code class="inline-code">malfind</code>, <strong>confirming a hollowed <code class="inline-code">lsass.exe</code> hosting network-capable shellcode</strong>.</p>
<pre><code class="sourceCode">Match Index:  0
Rule:         Windows_Trojan_Metasploit_7bc0f998
Tags:         
Author:       Elastic Security
Id:           7bc0f998-7014-4883-8a56-d5ee00c15aed
Fingerprint:  fdb5c665503f07b2fc1ed7e4e688295e1222a500bfb68418661db60c8e75e835
Creation_date: 2021-03-23
Last_modified: 2021-08-23
Description:  Identifies the API address lookup function leverage by metasploit shellcode
Threat_name:  Windows.Trojan.Metasploit
Severity:     84
Arch_context: x86
Scan_context: file, memory
License:      Elastic License v2
Os:           windows
Memory Type:  Virtual Memory (VAD)
Memory Tag:   
Base Address: 0x0000000140000000
PID:          12028
Process Name: lsass.exe
Process Path: \Device\HarddiskVolume3\Windows\System32\lsass.exe
CommandLine:  "C:\Windows\System32\lsass.exe"
User:         User
Created:      2025-01-27 02:30:54 UTC

Matches:
[]: 140004011

[] 140004011:
0000000140003fd0    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................
0000000140003fe0    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................
0000000140003ff0    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................
0000000140004000    fc 48 83 e4 f0 e8 c0 00  00 00 41 51 41 50 52 51   .H........AQAPRQ
0000000140004010    56 48 31 d2 65 48 8b 52  60 48 8b 52 18 48 8b 52   VH1.eH.R`H.R.H.R
0000000140004020    20 48 8b 72 50 48 0f b7  4a 4a 4d 31 c9 48 31 c0    H.rPH..JJM1.H1.
0000000140004030    ac 3c 61 7c 02 2c 20 41  c1 c9 0d 41 01 c1 e2 ed   .&lt;a|., A...A....
0000000140004040    52 41 51 48 8b 52 20 8b  42 3c 48 01 d0 8b 80 88   RAQH.R .B&lt;H.....

---------------------------------------------------------------------------------------

Match Index:  1
Rule:         Windows_Trojan_Metasploit_c9773203
Tags:         
Author:       Elastic Security
Id:           c9773203-6d1e-4246-a1e0-314217e0207a
Fingerprint:  afde93eeb14b4d0c182f475a22430f101394938868741ffa06445e478b6ece36
Creation_date: 2021-04-07
Last_modified: 2021-08-23
Description:  Identifies the 64 bit API hashing function used by Metasploit. This has been re-used by many other malware families.
Threat_name:  Windows.Trojan.Metasploit
Reference:    https://github.com/rapid7/metasploit-framework/blob/04e8752b9b74cbaad7cb0ea6129c90e3172580a2/external/source/shellcode/windows/x64/src/block/block_api.asm
Severity:     10
Arch_context: x86
Scan_context: file, memory
License:      Elastic License v2
Os:           windows
Memory Type:  Virtual Memory (VAD)
Memory Tag:   
Base Address: 0x0000000140000000
PID:          12028
Process Name: lsass.exe
Process Path: \Device\HarddiskVolume3\Windows\System32\lsass.exe
CommandLine:  "C:\Windows\System32\lsass.exe"
User:         User
Created:      2025-01-27 02:30:54 UTC

Matches:
[]: 140004075

[] 140004075:
0000000140004030    ac 3c 61 7c 02 2c 20 41  c1 c9 0d 41 01 c1 e2 ed   .&lt;a|., A...A....
0000000140004040    52 41 51 48 8b 52 20 8b  42 3c 48 01 d0 8b 80 88   RAQH.R .B&lt;H.....
0000000140004050    00 00 00 48 85 c0 74 67  48 01 d0 50 8b 48 18 44   ...H..tgH..P.H.D
0000000140004060    8b 40 20 49 01 d0 e3 56  48 ff c9 41 8b 34 88 48   .@ I...VH..A.4.H
0000000140004070    01 d6 4d 31 c9 48 31 c0  ac 41 c1 c9 0d 41 01 c1   ..M1.H1..A...A..
0000000140004080    38 e0 75 f1 4c 03 4c 24  08 45 39 d1 75 d8 58 44   8.u.L.L$.E9.u.XD
0000000140004090    8b 40 24 49 01 d0 66 41  8b 0c 48 44 8b 40 1c 49   .@$I..fA..HD.@.I
00000001400040a0    01 d0 41 8b 04 88 48 01  d0 41 58 41 58 5e 59 5a   ..A...H..AXAX^YZ

---------------------------------------------------------------------------------------

Match Index:  2
Rule:         Windows_Trojan_Metasploit_91bc5d7d
Tags:         
Author:       Elastic Security
Id:           91bc5d7d-31e3-4c02-82b3-a685194981f3
Fingerprint:  8848a3de66a25dd98278761a7953f31b7995e48621dec258f3d92bd91a4a3aa3
Creation_date: 2021-08-02
Last_modified: 2021-10-04
Threat_name:  Windows.Trojan.Metasploit
Reference_sample: 0dd993ff3917dc56ef02324375165f0d66506c5a9b9548eda57c58e041030987
Severity:     100
Arch_context: x86
Scan_context: file, memory
License:      Elastic License v2
Os:           windows
Memory Type:  Virtual Memory (VAD)
Memory Tag:   
Base Address: 0x0000000140000000
PID:          12028
Process Name: lsass.exe
Process Path: \Device\HarddiskVolume3\Windows\System32\lsass.exe
CommandLine:  "C:\Windows\System32\lsass.exe"
User:         User
Created:      2025-01-27 02:30:54 UTC

Matches:
[]: 1400040cb

[] 1400040cb:
0000000140004080    38 e0 75 f1 4c 03 4c 24  08 45 39 d1 75 d8 58 44   8.u.L.L$.E9.u.XD
0000000140004090    8b 40 24 49 01 d0 66 41  8b 0c 48 44 8b 40 1c 49   .@$I..fA..HD.@.I
00000001400040a0    01 d0 41 8b 04 88 48 01  d0 41 58 41 58 5e 59 5a   ..A...H..AXAX^YZ
00000001400040b0    41 58 41 59 41 5a 48 83  ec 20 41 52 ff e0 58 41   AXAYAZH.. AR..XA
00000001400040c0    59 5a 48 8b 12 e9 57 ff  ff ff 5d 49 be 77 73 32   YZH...W...]I.ws2
00000001400040d0    5f 33 32 00 00 41 56 49  89 e6 48 81 ec a0 01 00   _32..AVI..H.....
00000001400040e0    00 49 89 e5 49 bc 02 00  0d 3d c0 a8 00 9d 41 54   .I..I....=....AT
00000001400040f0    49 89 e4 4c 89 f1 41 ba  4c 77 26 07 ff d5 4c 89   I..L..A.Lw&amp;...L.

---------------------------------------------------------------------------------------

</code></pre>
<p><strong>Assessment:</strong> The YARA matches, their location inside the injected VAD, and the embedded network parameters indicate <strong>Metasploit-style payload behavior</strong> running within a <strong>process-hollowed LSASS</strong>, corroborating earlier <code class="inline-code">ldrmodules</code> and <code class="inline-code">malfind</code> findings.</p>
<p>Although Volatility 3 (<code class="inline-code">windows.netstat</code>, <code class="inline-code">windows.netscan</code>) did not yield networking artifacts, <strong>MemProcFS</strong> recovered the missing evidence and reconstructed the connection details:  </p>
<figure class="figure">
<img src="./assets/lsass RDP.png" alt="lsass RDP">
<figcaption>lsass RDP</figcaption>
</figure>
<p><strong>Result:</strong> <code class="inline-code">lsass.exe</code> connected to <strong>192.168.0.157:3389</strong> at <strong>2025-01-27 02:30:55 UTC</strong>-exactly what we’d expect given the Elastic YARA hits on the injected VAD (Metasploit-style connect stub).</p>
<h3>MITRE ATT&amp;CK</h3>

<div class="callout">
  <ul>
    <li><strong>T1055 - Process Injection</strong> (primary)
      <ul>
        <li><strong>T1055.012 - Process Hollowing</strong> (sub-technique)</li>
      </ul>
    </li>
    <li><strong>T1021 - Remote Services</strong> <em>(RDP)</em>
      <ul>
        <li><strong>T1021.001 - Remote Services: RDP</strong> <em>(lateral movement via RDP)</em></li>
      </ul>
    </li>
  </ul>
</div>

<hr>
<h3>Timelining - MemProcFS:</h3>
<p>MemProcFS exports multiple timeline CSVs (e.g., <strong>NTFS</strong>, <strong>Processes</strong>, <strong>Network</strong>). By normalizing to UTC and merging these files, we can build a single, ordered chronology of the threat actor’s activity and correlate file events, process launches, and connections into one coherent timeline.</p>
<p><code class="inline-code">invoice.pdf.exe</code></p>
<figure class="figure">
<img src="./assets/invoice timeline.png" alt="invoice timeline">
<figcaption>invoice timeline</figcaption>
</figure>
<p><code class="inline-code">invoice.pdf.exe</code> was <strong>created at 2025-01-27 01:34:28 UTC</strong> and <strong>executed at ~2025-01-27 02:30:49 UTC</strong>. This is corroborated by the Prefetch artifact (<code class="inline-code">INVOICE.PDF.EXE-*.pf</code>) being created <strong>within 0-10 seconds of first run</strong> _(7 seconds here, at 02:30:56 UTC)_, and by the NTFS <strong>MOD</strong> event (<code class="inline-code">M</code> in <strong>MACB</strong>) at <strong>02:30:49 UTC</strong>, which reflects metadata updates occurring at execution time.</p>
<p><code class="inline-code">svchost.exe</code></p>
<figure class="figure">
<img src="./assets/svchost timeline.png" alt="svchost timeline">
<figcaption>svchost timeline</figcaption>
</figure>
<p><code class="inline-code">C:\Users\User\AppData\Local\Temp\svchost.exe</code> was <strong>created at 2025-01-27 02:30:52 UTC</strong>, showed an <strong>NTFS MOD (M in MACB) at 02:30:53 UTC</strong>, and its Prefetch file <code class="inline-code">SVCHOST.EXE-8FEEB679.pf</code> was <strong>created at 02:30:55 UTC</strong>. Prefetch is generated within ~0-10 seconds of first run, so these artifacts indicate <strong>execution around 02:30:53-02:30:55 UTC</strong>.</p>
<p><code class="inline-code">Processes timeline:</code></p>
<figure class="figure">
<img src="./assets/Process timeline.png" alt="Process timeline">
<figcaption>Process timeline</figcaption>
</figure>
<ul>
<li><strong>02:30:54</strong> - <code class="inline-code">lsass.exe</code> (<strong>PID 12028</strong>, PPID 11872) starts - the rogue second instance.</li>
<li><strong>02:30:55</strong> - <code class="inline-code">cmd.exe</code> (<strong>PID 12088</strong>, PPID 12028) spawns from <code class="inline-code">lsass.exe</code>.</li>
<li><strong>02:30:55</strong> - <code class="inline-code">conhost.exe</code> (<strong>PID 12100</strong>, PPID 12088) attaches to <code class="inline-code">cmd.exe</code>.</li>
<li><strong>02:31:54 → 02:32:04</strong> - <code class="inline-code">systeminfo.exe</code> (<strong>PID 5240</strong>, PPID 12088) runs briefly under <code class="inline-code">cmd.exe</code>.</li>
</ul>
<p>From previous sections we know that <code class="inline-code">lsass.exe</code> connected to <strong>192.168.0.157:3389</strong> at <strong>2025-01-27 02:30:55 UTC</strong> (RDP) and that the Windows Defender has the following canges:</p>
<ul>
<li><strong>2025-01-27 02:27:18</strong> - <code class="inline-code">Downloads</code> folder added to Defender exclusions.</li>
<li><strong>2025-01-27 02:27:51</strong> - Defender Real-Time Protection disabled.</li>
</ul>
<p>Timelines table:</p>
<div class="table-container">
<table>
<thead><tr><th>Time (UTC)</th><th>Source</th><th>Artifact/Event</th><th>Details</th><th>MITRE ATT&amp;CK</th></tr></thead>
<tbody>
<tr><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td></tr>
<tr><td><strong>2025-01-27 01:34:28</strong></td><td>NTFS</td><td><code class="inline-code">invoice.pdf.exe</code> created</td><td><code class="inline-code">C:\Users\User\Downloads\invoice.pdf.exe</code></td><td>T1036 (masquerading)</td></tr>
<tr><td><strong>2025-01-27 02:27:18</strong></td><td>Defender Operational</td><td>Exclusion added</td><td><code class="inline-code">Downloads</code> folder added to Defender exclusions</td><td>T1562.001</td></tr>
<tr><td><strong>2025-01-27 02:27:51</strong></td><td>Defender Operational</td><td>Real-Time Protection disabled</td><td>RTP off</td><td>T1562.001</td></tr>
<tr><td><strong>2025-01-27 02:30:49</strong></td><td>NTFS/Prefetch</td><td><code class="inline-code">invoice.pdf.exe</code> executed</td><td>NTFS <code class="inline-code">MOD</code> at 02:30:49; Prefetch <code class="inline-code">INVOICE.PDF.EXE-*.pf</code> created at 02:30:56 (+7 s)</td><td>T1036, T1055 (stager)</td></tr>
<tr><td><strong>2025-01-27 02:30:52</strong></td><td>NTFS</td><td>Temp <code class="inline-code">svchost.exe</code> created</td><td><code class="inline-code">C:\Users\User\AppData\Local\Temp\svchost.exe</code></td><td>T1036</td></tr>
<tr><td><strong>2025-01-27 02:30:53</strong></td><td>NTFS</td><td>Temp <code class="inline-code">svchost.exe</code> metadata modified (execution-correlated)</td><td>NTFS <code class="inline-code">MOD</code> (M in MACB)</td></tr>
<tr><td><strong>2025-01-27 02:30:54</strong></td><td>MemProcFS VAD/YARA</td><td>Metasploit-style shellcode in LSASS</td><td>Hits in injected VAD @ <code class="inline-code">0x140000000</code> (block_api/API hashing), RWX+MZ</td><td>T1055, T1055.012</td></tr>
<tr><td><strong>2025-01-27 02:30:54</strong></td><td>Processes</td><td>Rogue <code class="inline-code">lsass.exe</code> started</td><td><code class="inline-code">PID 12028</code>, <code class="inline-code">PPID 11872</code></td><td>T1036</td></tr>
<tr><td><strong>2025-01-27 02:30:55</strong></td><td>Prefetch</td><td>Temp <code class="inline-code">svchost.exe</code> Prefetch created</td><td><code class="inline-code">SVCHOST.EXE-8FEEB679.pf</code></td></tr>
<tr><td><strong>2025-01-27 02:30:55</strong></td><td>Processes</td><td><code class="inline-code">cmd.exe</code> spawned by <code class="inline-code">lsass.exe</code></td><td><code class="inline-code">PID 12088</code> from <code class="inline-code">PID 12028</code>; <code class="inline-code">conhost.exe</code> (<code class="inline-code">PID 12100</code>) attaches</td><td>T1059</td></tr>
<tr><td><strong>2025-01-27 02:30:55</strong></td><td>MemProcFS Network</td><td>LSASS network connection</td><td><code class="inline-code">lsass.exe</code> → <code class="inline-code">192.168.0.157:3389</code> (RDP)</td><td>T1021.001</td></tr>
<tr><td><strong>2025-01-27 02:30:56</strong></td><td>Prefetch</td><td><code class="inline-code">invoice.pdf.exe</code> Prefetch created</td><td><code class="inline-code">INVOICE.PDF.EXE-*.pf</code></td></tr>
<tr><td><strong>2025-01-27 02:31:50</strong></td><td>Memory capture</td><td>System time at capture</td><td>Anchor</td></tr>
<tr><td><strong>2025-01-27 02:31:54</strong></td><td>Processes</td><td><code class="inline-code">systeminfo.exe</code> started (child of <code class="inline-code">cmd.exe</code>)</td><td><code class="inline-code">PID 5240</code> from <code class="inline-code">PID 12088</code>; exits at 02:32:04</td><td>T1059</td></tr>
</tbody></table>
</div>
<hr>
<h3>Closing thoughts</h3>
<p>This intrusion is well supported by the memory image. <strong>Defender was weakened before execution</strong> (Downloads exclusion at 2025-01-27 02:27:18 UTC and Real-Time Protection disabled at 02:27:51 UTC), creating space for the payload to run with minimal friction. <strong><code class="inline-code">invoice.pdf.exe</code></strong> then executed from Downloads at ~02:30:49 UTC, a masqueraded dropper confirmed by Amcache and Prefetch. Its imports and strings show a Go-based loader capable of thread/context manipulation and memory staging.</p>
<p>Within seconds, a fake <strong><code class="inline-code">svchost.exe</code></strong> appeared in <code class="inline-code">AppData\Local\Temp</code> (created 02:30:52, Prefetch 02:30:55), whose imports and strings describe a hollowing workflow (create suspended, allocate, write PE, set entry, resume). <strong>A second <code class="inline-code">lsass.exe</code> (PID 12028)</strong> then surfaced at 02:30:54 UTC. Memory triage (<code class="inline-code">ldrmodules</code>, <code class="inline-code">malfind</code>, <code class="inline-code">procsentinel</code>) identified an <strong>unmapped RWX region with an MZ header</strong> at 0x140000000 inside that LSASS instance, which Elastic YARA matched to <strong>Metasploit-style block_api/API hashing shellcode</strong>. The process graph showed <strong><code class="inline-code">lsass.exe → cmd.exe → conhost.exe/systeminfo.exe</code></strong>, consistent with hands-on activity, and <strong>MemProcFS</strong> recovered the missing network evidence: <strong><code class="inline-code">lsass.exe</code> connecting to 192.168.0.157:3389 at 02:30:55 UTC</strong>. Even though <code class="inline-code">pslist/psscan</code> did not retain short-lived launcher artifacts, the combined evidence chain is coherent and mutually reinforcing.</p>
<p><strong>Assessment:</strong> A user-executed, masqueraded dropper staged a Temp <code class="inline-code">svchost.exe</code> injector that <strong>hollowed a rogue <code class="inline-code">lsass.exe</code></strong> and ran <strong>Metasploit-style shellcode</strong> within it, followed by RDP activity and interactive commands. Confidence is high given the convergence of Prefetch/Amcache, Defender Operational logs, process timelines, injected VAD characteristics, YARA hits, and reconstructed network telemetry.</p>
<p><strong>Mapped TTPs</strong></p>
<ul>
<li><strong>T1055.012 - Process Hollowing</strong> (Temp <code class="inline-code">svchost.exe</code> creating the rogue LSASS)</li>
<li><strong>T1055 - Process Injection</strong> (injected RWX+MZ VAD in LSASS)</li>
<li><strong>T1036 - Masquerading</strong> (<code class="inline-code">invoice.pdf.exe</code> as a PDF, duplicate LSASS)</li>
<li><strong>T1562.001 - Impair Defenses</strong> (Defender exclusions and RTP disabled)</li>
<li><strong>T1021.001 - Remote Services: RDP</strong> (LSASS connection to 192.168.0.157:3389)</li>
<li><strong>T1059 - Command and Scripting Interpreter</strong> (LSASS spawning <code class="inline-code">cmd.exe</code>)</li>
</ul>
<p><strong>IOCs</strong></p>

<table>
  <thead>
    <tr><th>Type</th><th>Value</th><th>Artifact</th></tr>
  </thead>
  <tbody>
    <tr>
      <td>SHA256</td>
      <td><strong>B37156CF3019561D48E05F8258C51297C6CD0CC220FA3B7BD82EB13D549BEB63</strong></td>
      <td>invoice.pdf.exe</td>
    </tr>
    <tr>
      <td>SHA256</td>
      <td><strong>79AEC4FDF6CC931BCEE95EA14F627AA7347DFDD861290BD40F518580CE028D86</strong></td>
      <td>vchost.exe</td>
    </tr>
    <tr>
      <td>SHA256</td>
      <td><strong>8375F5DEAD870E3B208DD84512521DADA3A2AAA5A23AED096CB1AD878A43BA21</strong></td>
      <td>lsass-12028.exe</td>
    </tr>
    <tr>
      <td>Remote IP</td>
      <td><strong>192.168.0.157</strong></td>
      <td>RDP destination (3389)</td>
    </tr>
  </tbody>
</table>

</div>
<footer>
  <p>&copy; 2025 Tracepoint — Created by Itamar Hällström</p>
  <div class="social-links" style="margin-top: 1rem;">
    <a href="https://github.com/itamarhall" target="_blank" rel="noopener" style="margin: 0 1rem;">GitHub</a>
    <a href="https://www.linkedin.com/in/itamarhallstr/" target="_blank" rel="noopener" style="margin: 0 1rem;">LinkedIn</a>
    <a href="mailto:itamarhallstr@gmail.com" style="margin: 0 1rem;">Email</a>
  </div>
</footer>
</div>
<div id="lightbox" class="lightbox" aria-hidden="true">
  <button class="btn close" aria-label="Close">&times;</button>
  <button class="btn prev"  aria-label="Previous">&#10094;</button>
  <img id="lb-img" alt="">
  <div id="lb-cap" class="caption"></div>
  <button class="btn next"  aria-label="Next">&#10095;</button>
</div>

<script>
(() => {
  const figs = Array.from(document.querySelectorAll('.figure'));
  const imgs = figs.map(f => f.querySelector('img')).filter(Boolean);

  // Optional: give a higher-res source via data-full="path/to/big.png"
  // Otherwise the current src is used.
  const lb   = document.getElementById('lightbox');
  const lbi  = document.getElementById('lb-img');
  const lbc  = document.getElementById('lb-cap');
  const btnPrev = lb.querySelector('.prev');
  const btnNext = lb.querySelector('.next');
  const btnClose= lb.querySelector('.close');

  let i = 0;
  const show = (idx) => {
    i = (idx + imgs.length) % imgs.length;
    const img = imgs[i];
    lbi.src = img.dataset.full || img.src;
    lbi.alt = img.alt || '';
    const capEl = figs[i].querySelector('figcaption');
    lbc.textContent = capEl ? capEl.textContent : '';
    lb.classList.add('show');
    lb.setAttribute('aria-hidden','false');
  };
  const close = () => {
    lb.classList.remove('show');
    lb.setAttribute('aria-hidden','true');
    // Prevent stale large images from consuming memory when closed
    setTimeout(() => { lbi.removeAttribute('src'); }, 200);
  };

  imgs.forEach((img, idx) => {
    img.addEventListener('click', () => show(idx));
  });

  btnPrev.addEventListener('click', (e) => { e.stopPropagation(); show(i-1); });
  btnNext.addEventListener('click', (e) => { e.stopPropagation(); show(i+1); });
  btnClose.addEventListener('click', (e) => { e.stopPropagation(); close(); });

  // Click outside image closes
  lb.addEventListener('click', (e) => { if (e.target === lb) close(); });

  // Keyboard controls
  window.addEventListener('keydown', (e) => {
    if (!lb.classList.contains('show')) return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowRight') show(i+1);
    if (e.key === 'ArrowLeft')  show(i-1);
  });
})();


</script>
<script src="/Tracepoint/js/main.js?v=3"></script>
<script>
// Fallback theme toggle for LSASS page
(function() {
  const themeToggle = document.getElementById('theme-toggle');
  if (!themeToggle) return;

  // Load saved theme or default to dark
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeIcon(savedTheme);

  themeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
    
    // Add transition effect
    document.body.style.transition = 'all 0.3s ease';
    setTimeout(() => {
      document.body.style.transition = '';
    }, 300);
  });

  function updateThemeIcon(theme) {
    const themeToggle = document.getElementById('theme-toggle');
    if (!themeToggle) return;
    
    themeToggle.innerHTML = theme === 'dark' ? '☀️' : '🌙';
    themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
  }
})();
</script>
</body>
</html>
